<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Real-time pitch detection and visualization tool for musicians">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <title>PitchWiz - Real-time Pitch Detection</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">

    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="profile-styles.css">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- JSZip Library for Export/Import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>

<body>
    <div class="app-container">
        <!-- Minimal Header -->
        <header class="header">
            <div class="logo">
                <svg class="logo-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 18V5l12-2v13" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                    <circle cx="6" cy="18" r="3" stroke="currentColor" stroke-width="2" />
                    <circle cx="18" cy="16" r="3" stroke="currentColor" stroke-width="2" />
                </svg>
                <h1>PitchWiz</h1>
            </div>
            <div id="appStatus" class="app-status compact">IDLE</div>
        </header>

        <!-- Playback Controls (Static Bar) -->
        <div id="playbackControls" class="playback-controls">
            <div class="playback-info">
                <span id="playbackTime">0:00</span>
                <span class="playback-divider">/</span>
                <span id="playbackDuration">0:00</span>
            </div>

            <div class="playback-display">
                <button class="icon-btn small" id="loopBtn" title="Loop Playback">
                    <svg viewBox="0 0 24 24" fill="none" class="loop-icon">
                        <path d="M17 1l4 4-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                        <path d="M3 11V9a4 4 0 0 1 4-4h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                        <path d="M7 23l-4-4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                        <path d="M21 13v2a4 4 0 0 1-4 4H3" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                </button>

                <button class="icon-btn small" id="playPauseBtn" title="Play/Pause">
                    <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor">
                        <polygon points="5 3 19 12 5 21 5 3" />
                    </svg>
                    <svg class="pause-icon" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
                        <rect x="6" y="4" width="4" height="16" />
                        <rect x="14" y="4" width="4" height="16" />
                    </svg>
                </button>

                <div class="seek-container">
                    <input type="range" id="seekBar" class="seek-bar" min="0" max="100" value="0">
                    <div class="seek-progress" id="seekProgress"></div>
                </div>

                <button class="icon-btn small close-btn" id="closePlaybackBtn" title="Close Playback">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
        </div>


        <!-- Navigation Tabs -->
        <nav class="nav-tabs">
            <button class="nav-tab active" data-mode="view">View</button>
            <button class="nav-tab" data-mode="library">Library</button>
            <button class="nav-tab" data-mode="practice">Practice</button>
            <button class="nav-tab" data-mode="progress">Progress</button>
        </nav>

        <!-- Action Bar -->
        <div class="action-bar">
            <button class="action-btn" id="startBtn" aria-label="Start Listening" title="Start Listening">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="9" y="2" width="6" height="12" rx="3" stroke="currentColor" stroke-width="2" />
                    <path d="M5 10v2a7 7 0 0014 0v-2M12 19v3m-4 0h8" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" />
                </svg>
                <span>Mic</span>
            </button>
            <button class="action-btn record-btn" id="recordBtn" aria-label="Record" title="Start Recording">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="8" fill="currentColor" />
                </svg>
                <span>Record</span>
            </button>
            <button class="action-btn compact" id="viewModeSwitcher" title="Switch view mode">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 12h16m0 0l-6-6m6 6l-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
                <span id="currentViewMode">Pitch</span>
            </button>
            <button class="action-btn" id="settingsBtn" aria-label="Settings" title="Settings">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" />
                    <path d="M12 1v6m0 6v10M1 12h6m6 0h10" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" />
                </svg>
                <span>Settings</span>
            </button>
        </div>

        <div id="recordingTimer" class="recording-timer" style="display: none;">00:00</div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Playback Controls (Hidden by default) -->
            <div id="playbackControls" class="playback-controls">
                <div class="playback-info">
                    <span id="playbackTime">0:00</span>
                    <span class="playback-divider">/</span>
                    <span id="playbackDuration">0:00</span>
                </div>
                <div class="playback-display">
                    <button class="icon-btn" id="playPauseBtn" title="Play/Pause">
                        <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor">
                            <polygon points="5 3 19 12 5 21 5 3" />
                        </svg>
                        <svg class="pause-icon" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
                            <rect x="6" y="4" width="4" height="16" />
                            <rect x="14" y="4" width="4" height="16" />
                        </svg>
                    </button>
                    <div class="seek-container">
                        <input type="range" id="seekBar" class="seek-bar" min="0" max="100" value="0">
                        <div class="seek-progress" id="seekProgress"></div>
                    </div>
                </div>
                <button class="icon-btn close-playback" id="closePlaybackBtn" title="Close Playback">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>

            <!-- Library View (Hidden by default) -->
            <div id="libraryView" class="library-view" style="display: none;">
                <div class="library-header">
                    <h2>Your recordings</h2>
                    <div class="library-actions">
                        <button class="btn secondary" id="btnExportLibrary" title="Export library to ZIP">
                            üì¶ Export
                        </button>
                        <button class="btn secondary" id="btnImportLibrary" title="Import library from ZIP">
                            üì• Import
                        </button>
                        <input type="file" id="importFileInput" accept=".zip" style="display: none;">
                        <button class="btn-danger" id="resetLibraryBtn" title="Clear all recordings">
                            üóëÔ∏è Reset
                        </button>
                    </div>
                </div>
                <div id="libraryList" class="library-list">
                    <!-- Recordings injected here -->
                </div>
            </div>

            <!-- Visualization Canvas -->
            <div class="visualization-container" id="visualizationContainer">
                <canvas id="visualizationCanvas"></canvas>
                <div class="canvas-overlay">
                    <div class="grid-lines"></div>
                </div>
                <div class="zoom-hint">
                    <span>üñ±Ô∏è Drag ‚ÜïÔ∏è: V-Zoom | Drag ‚ÜîÔ∏è: H-Zoom</span>
                </div>
            </div>

            <!-- Compact Tuner Display -->
            <div class="note-display" id="noteDisplay">
                <div class="note-name" id="noteName">--</div>
                <div class="octave" id="octave"></div>
                <div class="frequency" id="frequency">-- Hz</div>
                <div class="cents-indicator">
                    <div class="cents-bar">
                        <div class="cents-marker" id="centsMarker"></div>
                        <div class="cents-center"></div>
                    </div>
                    <div class="cents-value" id="centsValue">0¬¢</div>
                </div>
            </div>

            <!-- Waveform Gain Control (visible in tuner mode) -->
            <div class="waveform-gain-control" id="waveformGainControl"
                style="display: none; margin-bottom: var(--spacing-lg);">
                <label for="waveformGainMain"
                    style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                    Waveform Gain: <span id="waveformGainMainValue"
                        style="color: var(--color-accent-primary);">2.0x</span>
                </label>
                <input type="range" id="waveformGainMain" min="50" max="1000" value="200" step="10"
                    style="width: 100%;">
            </div>

            <!-- Controls -->
            <div class="controls">
                <!-- Modes moved to top nav -->
            </div>

            <!-- Progress Dashboard View -->
            <div id="progressView" class="view-container" style="display: none;">
                <div class="progress-header">
                    <h2>Your Progress</h2>
                    <select id="singerSelect" class="singer-select">
                        <option value="all">All Singers</option>
                    </select>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalSessions">0</div>
                        <div class="stat-label">Sessions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgAccuracy">0%</div>
                        <div class="stat-label">Avg Accuracy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="timePracticed">0h</div>
                        <div class="stat-label">Time Practiced</div>
                    </div>
                </div>

                <div class="charts-container">
                    <div class="chart-card">
                        <h3>Accuracy Over Time</h3>
                        <canvas id="accuracyChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>Accuracy per Note</h3>
                        <canvas id="accuracyPerNoteChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Practice Modes View -->
            <div id="practiceView" class="view-container" style="display: none;">
                <div class="practice-header">
                    <h2>üéµ Practice Modes</h2>
                    <button class="btn-danger-outline" onclick="resetPracticeProgress()"
                        title="Reset all practice progress">
                        üîÑ Reset Progress
                    </button>
                </div>

                <!-- Exercise Cards -->
                <div class="exercise-cards">
                    <div class="exercise-card">
                        <div class="exercise-icon">üéØ</div>
                        <h3>Intune Exercises</h3>
                        <p>Master each note in your range</p>
                        <!-- Puck Grid Progress -->
                        <div id="intunePuckGrid" class="intune-puck-grid">
                            <!-- Populated by JS -->
                        </div>
                        <p class="progress-text" style="display:none;"><span id="intuneCompleted">0</span>/<span
                                id="intuneTotal">0</span> notes</p>
                        <button class="btn-primary" onclick="startIntuneExercise()" id="btnStartIntune">Start
                            Practice</button>
                    </div>

                    <div class="exercise-card">
                        <div class="exercise-icon">üéº</div>
                        <h3>Interval Training</h3>
                        <p>Practice intervals from easy steps to difficult leaps.</p>
                        <button class="btn-primary" onclick="openIntervalSetup()">Setup Practice</button>
                    </div>
                </div>
            </div>

        </main>


        <!-- Range Calibration Modal -->
        <div id="rangeCalibrationModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üéµ Calibrate Your Vocal Range</h2>
                    <button class="close-btn" onclick="closeRangeCalibration()">√ó</button>
                </div>
                <div class="modal-body">
                    <p class="calibration-instruction">Let's find your comfortable singing range!</p>

                    <div class="calibration-step">
                        <h3>Step 1: Lowest Note</h3>
                        <p>Sing your lowest comfortable note and hold it</p>
                        <button class="btn-calibrate" id="btnRecordLowest" onclick="recordLowestNote()">
                            <span class="btn-icon">üé§</span>
                            <span class="btn-text">Record Lowest Note</span>
                        </button>
                        <div class="detected-note" id="detectedLowest">--</div>
                    </div>

                    <div class="calibration-step">
                        <h3>Step 2: Highest Note</h3>
                        <p>Sing your highest comfortable note and hold it</p>
                        <button class="btn-calibrate" id="btnRecordHighest" onclick="recordHighestNote()" disabled>
                            <span class="btn-icon">üé§</span>
                            <span class="btn-text">Record Highest Note</span>
                        </button>
                        <div class="detected-note" id="detectedHighest">--</div>
                    </div>

                    <div class="range-result" id="rangeResult" style="display: none;">
                        <h3>‚úÖ Your Range</h3>
                        <p class="range-summary">
                            <strong><span id="resultLowest">--</span> to <span id="resultHighest">--</span></strong>
                            (<span id="resultCount">--</span> notes)
                        </p>
                        <button class="btn-primary" onclick="saveVocalRange()">Save & Continue</button>
                    </div>
                </div>
            </div>
        </div>


        <!-- Intune Exercise Modal -->
        <div id="intuneExerciseModal" class="modal">
            <div class="modal-content large-modal">
                <div class="modal-header">
                    <h2>üéØ Intune Practice</h2>
                    <div id="exerciseHeaderInfo"
                        style="font-size: 0.9rem; color: #888; font-weight: normal; margin-top: 5px;"></div>
                    <button class="close-btn" onclick="closeIntuneExercise()">√ó</button>
                </div>

                <div class="exercise-layout">
                    <!-- Left: Note Selection Grid -->
                    <div class="note-grid-container">
                        <h3>Select a Note</h3>
                        <div id="noteGrid" class="note-grid">
                            <!-- Notes will be populated via JS -->
                        </div>
                    </div>

                    <!-- Right: Active Practice Area -->
                    <div class="active-practice-area">
                        <div class="target-note-display">
                            <span id="targetNoteDisplay">--</span>
                            <div class="freq-display" id="targetFreqDisplay">0 Hz</div>
                        </div>

                        <!-- Real-time Pitch Visualization -->
                        <div class="practice-visualizer-container">
                            <canvas id="practiceVisualizerCanvas" width="700" height="200"></canvas>
                        </div>

                        <div class="exercise-status" id="exerciseStatus">Select a note to start</div>

                        <div class="exercise-controls">
                            <button id="btnPlayTone" class="btn-primary" disabled onclick="playReferenceTone()">
                                üîä Play Tone
                            </button>
                            <button id="btnRecordExercise" class="btn-primary" disabled
                                onclick="recordExerciseAttempt()">
                                üé§ Sing Now
                            </button>
                            <button id="btnPrevNote" class="btn-secondary" onclick="selectPrevNote()">
                                ‚¨ÖÔ∏è Prev
                            </button>
                            <button id="btnNextNote" class="btn-secondary" disabled onclick="selectNextNote()">
                                Next ‚û°Ô∏è
                            </button>
                        </div>

                        <!-- Results Section -->
                        <div id="exerciseResult" class="exercise-result" style="display: none;">
                            <div class="score-circle">
                                <span id="scoreValue">0%</span>
                            </div>
                            <p id="scoreFeedback">Good job!</p>
                            <button id="btnSaveResult" class="btn-secondary"
                                style="margin-top: 10px; width: 100%; display: none;"
                                onclick="saveLastRecordingToLibrary()">üíæ Save to Library</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Settings View (Full Page) -->
        <div id="settingsView" class="view-container" style="display: none;">
            <div class="settings-page">
                <h2 class="settings-title">Settings</h2>

                <!-- Audio & Detection Section -->
                <div class="settings-section">
                    <h3 class="section-title">Audio & Detection</h3>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label for="a4Frequency">A4 Reference Frequency</label>
                            <input type="number" id="a4Frequency" value="440" min="430" max="450" step="1">
                            <span class="setting-hint">Standard tuning: 440 Hz</span>
                        </div>
                        <div class="setting-item">
                            <label for="detectionModeSelect">Detection Mode</label>
                            <select id="detectionModeSelect">
                                <option value="on-sound">On Sound</option>
                                <option value="live">Live Mode</option>
                            </select>
                            <span class="setting-hint">On Sound: only when pitch detected | Live: continuous</span>
                        </div>
                        <div class="setting-item">
                            <label for="smoothing">Smoothing: <span id="smoothingValue">70</span></label>
                            <input type="range" id="smoothing" min="0" max="100" value="70">
                            <span class="setting-hint">Reduces noise. Higher values = smoother for vocals</span>
                        </div>
                    </div>
                </div>

                <!-- Tuning & Display Section -->
                <div class="settings-section">
                    <h3 class="section-title">Tuning & Display</h3>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label for="tuningTolerance">Tuning Tolerance: <span
                                    id="tuningToleranceValue">5¬¢</span></label>
                            <input type="range" id="tuningTolerance" min="3" max="15" value="5" step="1">
                            <span class="setting-hint">How close to be "in tune" (green indicator)</span>
                        </div>
                        <div class="setting-item">
                            <label>Pitch Range</label>
                            <div class="range-selectors">
                                <select id="minNoteSelect"></select>
                                <span>to</span>
                                <select id="maxNoteSelect"></select>
                            </div>
                            <span class="setting-hint">Visible note range for pitch diagram</span>
                        </div>
                        <div class="setting-item">
                            <label for="zoomLevel">Vertical Zoom: <span id="zoomValue">1.0x</span></label>
                            <input type="range" id="zoomLevel" min="50" max="300" value="100" step="10">
                            <span class="setting-hint">Zoom in/out on the pitch range</span>
                        </div>
                    </div>
                </div>

                <!-- Visualization Section -->
                <div class="settings-section">
                    <h3 class="section-title">Visualization</h3>
                    <div class="settings-grid">
                        <div class="setting-item auto-zoom-item">
                            <label class="toggle-switch">
                                <input type="checkbox" id="autoZoom">
                                <span class="toggle-slider"></span>
                                <span class="toggle-label">Automatic Zoom</span>
                            </label>
                            <span class="setting-hint">Automatically zooms to fit your singing range</span>
                        </div>
                        <div class="setting-item">
                            <label for="viewModeSelect">View Mode</label>
                            <select id="viewModeSelect">
                                <option value="pitch-diagram">Pitch Diagram</option>
                                <option value="spectrogram">Spectrogram</option>
                                <option value="tuner">Tuner</option>
                            </select>
                            <span class="setting-hint">Current visualization mode</span>
                        </div>
                        <div class="setting-item">
                            <label for="scanSpeed">Scan Speed: <span id="scanSpeedValue">1.0x</span></label>
                            <input type="range" id="scanSpeed" min="50" max="200" value="100" step="10">
                            <span class="setting-hint">How fast the diagram scrolls (pitch diagram only)</span>
                        </div>
                        <div class="setting-item">
                            <label>
                                <input type="checkbox" id="showSpectrogramNotes" checked>
                                Show note labels on spectrogram
                            </label>
                            <span class="setting-hint">Display musical notes on the right side</span>
                        </div>
                        <div class="setting-item">
                            <label for="waveformGain">Waveform Gain: <span id="waveformGainValue">2.0x</span></label>
                            <input type="range" id="waveformGain" min="50" max="1000" value="200" step="10">
                            <span class="setting-hint">Waveform amplitude in tuner mode</span>
                        </div>
                    </div>
                </div>

                <!-- Profile Section -->
                <div class="settings-section">
                    <h3 class="section-title">Singer Profile</h3>
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label for="profileSelect">Current Profile</label>
                            <select id="profileSelect">
                                <option value="guest">Guest</option>
                            </select>
                            <span class="setting-hint">Select or create a singer profile</span>
                        </div>
                        <div class="setting-item">
                            <label for="profileName">Profile Name</label>
                            <input type="text" id="profileName" placeholder="Enter profile name">
                            <button class="btn-secondary" id="saveProfileBtn">Save Profile</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Tuning Reference Modal -->
        <div class="modal" id="tuningRefModal">
            <div class="modal-content compact">
                <div class="modal-header">
                    <h3>Tuning Reference</h3>
                    <button class="close-btn" id="closeTuningRef">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="setting-group">
                        <label for="tuningRefInput">A4 Frequency (Hz)</label>
                        <input type="number" id="tuningRefInput" min="400" max="480" step="0.1" value="440">
                        <span class="setting-hint">Standard: 440 Hz | Baroque: 415 Hz</span>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn-secondary" id="tuningRefCancel">Cancel</button>
                    <button class="btn-primary" id="tuningRefSave">Save</button>
                </div>
            </div>
        </div>

        <!-- Save Recording Modal -->
        <div id="saveModal" class="modal">
            <div class="modal-content small">
                <div class="modal-header">
                    <h2>Save Recording</h2>
                    <button class="icon-btn close-modal" id="closeSaveModal">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Recording Name</label>
                        <input type="text" id="recordingNameInput" placeholder="Recording #001">
                    </div>
                    <div class="form-group">
                        <label>Singer / Musician</label>
                        <input type="text" id="singerNameInput" placeholder="Enter name">
                    </div>
                    <div class="modal-actions">
                        <button class="btn secondary" id="discardBtn">Discard</button>
                        <button class="btn primary" id="saveRecordingBtn">Save Recording</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Modal -->
        <div id="profileModal" class="modal">
            <div class="modal-content compact">
                <div class="modal-header">
                    <h2>Singer Profile</h2>
                    <button class="icon-btn close-modal" id="closeProfileModal">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="profile-compact">
                        <div class="profile-row">
                            <strong id="currentProfileName">Loading...</strong>
                            <span class="status-badge" id="profileCalibrationStatus">Not Calibrated</span>
                        </div>
                        <button class="btn primary compact" id="openCalibrationBtn">
                            üìä Calibrate Range
                        </button>
                    </div>

                    <div class="singer-list-section">
                        <label>Switch Profile</label>
                        <select id="singerListSelect" class="singer-select">
                            <option value="">-- Select a singer --</option>
                        </select>
                        <div class="or-divider">or</div>
                        <input type="text" id="profileSingerInput" placeholder="Create new profile">
                        <button class="btn secondary compact" id="createProfileBtn">Create New</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export/Import Progress Modal -->
        <div id="exportImportModal" class="modal">
            <div class="modal-content compact">
                <div class="modal-header">
                    <h2 id="exportImportTitle">Processing...</h2>
                </div>
                <div class="modal-body">
                    <div class="progress-container">
                        <div class="progress-bar" id="exportImportProgress"></div>
                    </div>
                    <p id="exportImportStatus">Preparing...</p>
                    <div class="modal-actions" style="margin-top: 15px; justify-content: center;">
                        <button class="btn primary" id="btnCloseExportImport" style="display: none;"
                            onclick="document.getElementById('exportImportModal').style.display='none'">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Interval Configuration Modal -->
        <div id="intervalConfigModal" class="modal">
            <div class="modal-content compact">
                <div class="modal-header">
                    <h2>Interval Practice Setup</h2>
                    <button class="icon-btn close-modal" onclick="closeIntervalConfig()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Difficulty Level</label>
                        <div class="level-cards">
                            <div class="level-card" onclick="selectLevel('beginner')" id="lvl_beginner">
                                <div class="lvl-icon">üü¢</div>
                                <div class="lvl-info">
                                    <strong>Easy</strong>
                                    <span>Fundamental (Oct, M2, M3, P5)</span>
                                </div>
                            </div>
                            <div class="level-card" onclick="selectLevel('intermediate')" id="lvl_intermediate">
                                <div class="lvl-icon">üü°</div>
                                <div class="lvl-info">
                                    <strong>Intermediate</strong>
                                    <span>Basic (+ m2, m3, P4, M6)</span>
                                </div>
                            </div>
                            <div class="level-card" onclick="selectLevel('advanced')" id="lvl_advanced">
                                <div class="lvl-icon">üü†</div>
                                <div class="lvl-info">
                                    <strong>Advanced</strong>
                                    <span>Tension (+ TT, m6, 7ths)</span>
                                </div>
                            </div>
                            <div class="level-card" onclick="selectLevel('expert')" id="lvl_expert">
                                <div class="lvl-icon">üî¥</div>
                                <div class="lvl-info">
                                    <strong>Expert</strong>
                                    <span>Extensions (+ 9th, 11th, 13th)</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Direction</label>
                        <div class="direction-toggle">
                            <button class="toggle-btn active" onclick="selectDirection('asc')" id="dir_asc">Ascending
                                ‚ÜóÔ∏è</button>
                            <button class="toggle-btn" onclick="selectDirection('desc')" id="dir_desc">Descending
                                ‚ÜòÔ∏è</button>
                            <button class="toggle-btn" onclick="selectDirection('random')" id="dir_random">Random
                                üîÄ</button>
                        </div>
                    </div>

                    <div class="modal-actions centered">
                        <button class="btn primary" onclick="startIntervalSession()">Start Practice</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Interval Active Practice View (Modal) -->
        <div id="intervalPracticeModal" class="modal fullscreen">
            <div class="modal-content fullscreen-content">
                <div class="practice-header-bar">
                    <button class="icon-btn" onclick="closeIntervalPractice()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 12H5M12 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <div class="practice-title">
                        <span id="intervalLevelBadge">Intermediate</span>
                        <span id="intervalNameDisplay">Waiting...</span>
                    </div>
                    <div class="practice-score" id="intervalScoreDisplay">0%</div>
                </div>

                <div class="interval-visualizer">
                    <div class="interval-visualizer">
                        <!-- Scrolling Pitch Diagram -->
                        <canvas id="intervalCanvas" width="500" height="200"
                            style="width: 100%; height: 200px; border-radius: 8px; background: rgba(0,0,0,0.2); margin-bottom: 20px;"></canvas>

                        <!-- Large Pucks for visual feedback -->
                        <div class="interval-pucks">
                            <div class="note-puck reference" id="refPuck">
                                <span class="note-val">C3</span>
                                <span class="note-label">Reference</span>
                            </div>
                            <div class="interval-arrow">‚ûù</div>
                            <div class="note-puck target" id="targetPuck">
                                <span class="note-val">?</span>
                                <span class="note-label">Target</span>
                            </div>
                        </div>
                        <div class="instruction-text" id="intervalInstruction">Listen to the reference note...</div>
                    </div>

                    <div class="practice-controls-bar">
                        <button class="control-btn secondary" onclick="replayReference()">
                            üëÇ Hear Reference
                        </button>
                        <button class="control-btn secondary" onclick="playTargetTone()"
                            title="Cheat: Hear the target note">
                            üéØ Target Tone
                        </button>
                        <button class="control-btn primary" id="btnRecordInterval" onclick="toggleIntervalRecording()">
                            üî¥ Sing
                        </button>
                        <button class="control-btn primary" id="btnSaveInterval" style="display: none;"
                            onclick="triggerIntervalSave()">
                            üíæ Save
                        </button>
                        <button class="control-btn secondary" id="btnRetryInterval" style="display: none;"
                            onclick="retryInterval()">
                            üîÑ Retry
                        </button>
                        <button class="control-btn secondary" onclick="nextInterval()">
                            Next ‚û°Ô∏è
                        </button>
                    </div>
                </div>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script src="db-manager.js"></script>
            <script src="recording-manager.js"></script>
            <script src="progress-tracker.js"></script>
            <script src="tone-generator.js"></script>
            <script src="pitch-detector.js"></script>
            <script src="visualizer.js"></script>
            <script src="app.js"></script>
            <script src="practice-functions.js"></script>
            <script src="interval-functions.js"></script>
            <script src="practice-integration.js"></script>
            <script src="export-import.js"></script>

            <!-- Service Worker Registration -->
            <script>
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register('service-worker.js')
                            .then(reg => console.log('Service Worker registered'))
                            .catch(err => console.log('Service Worker registration failed'));
                    });
                }
            </script>
</body>

</html>